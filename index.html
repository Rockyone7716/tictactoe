<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OOXX é ç«¯é€£ç·šç‰ˆ</title>
    <style>
        :root { --bg-color: #f0f2f5; --cell-size: 100px; --x-color: #ff4d4d; --o-color: #3b82f6; }
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: var(--bg-color); }
        .setup { margin-bottom: 20px; text-align: center; }
        .board { display: grid; grid-template-columns: repeat(3, var(--cell-size)); gap: 10px; background: #ccc; padding: 10px; border-radius: 10px; display: none; }
        .cell { width: var(--cell-size); height: var(--cell-size); background: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; border-radius: 5px; }
        .cell.x { color: var(--x-color); } .cell.o { color: var(--o-color); }
        .status { font-size: 1.2rem; margin: 20px; font-weight: bold; }
        input { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; background: #333; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>OOXX é ç«¯é€£ç·šç‰ˆ</h1>

    <div class="setup" id="setup-area">
        <input type="text" id="room-id" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿç¢¼ (å¦‚: 888)">
        <button onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
        <p style="font-size: 0.8rem; color: #666;">èˆ‡æœ‹å‹è¼¸å…¥ç›¸åŒè™Ÿç¢¼å³å¯é€£ç·š</p>
    </div>

    <div class="status" id="status">è«‹å…ˆé€²å…¥æˆ¿é–“</div>

    <div class="board" id="board">
        <div class="cell" onclick="makeMove(0)" id="c0"></div>
        <div class="cell" onclick="makeMove(1)" id="c1"></div>
        <div class="cell" onclick="makeMove(2)" id="c2"></div>
        <div class="cell" onclick="makeMove(3)" id="c3"></div>
        <div class="cell" onclick="makeMove(4)" id="c4"></div>
        <div class="cell" onclick="makeMove(5)" id="c5"></div>
        <div class="cell" onclick="makeMove(6)" id="c6"></div>
        <div class="cell" onclick="makeMove(7)" id="c7"></div>
        <div class="cell" onclick="makeMove(8)" id="c8"></div>
    </div>

    <button onclick="resetGame()" style="margin-top:20px; display:none;" id="reset-btn">é‡æ–°é–‹å§‹</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBiRD8NX4VkzySZACcbccTn0t8KkHLCWKA",
            authDomain: "ooxx-test.firebaseapp.com",
            databaseURL: "https://ooxx-test-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ooxx-test",
            storageBucket: "ooxx-test.firebasestorage.app",
            messagingSenderId: "1044547887449",
            appId: "1:1044547887449:web:1c98e76f50fb36cc952c48"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentRoom = "";
        let myRole = ""; // X æˆ– O
        let currentTurn = "X";
        let gameState = Array(9).fill("");

        window.joinRoom = () => {
            const id = document.getElementById('room-id').value;
            if (!id) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼");
            currentRoom = id;
            
            // ç›£è½æˆ¿é–“æ•¸æ“š
            const roomRef = ref(db, 'rooms/' + currentRoom);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    // æˆ¿é–“ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–æˆ¿é–“
                    myRole = "X";
                    updateRoom({ board: gameState, turn: "X" });
                } else {
                    if (!myRole) myRole = "O"; // ç¬¬äºŒå€‹é€²ä¾†çš„äººæ˜¯ O
                    gameState = data.board;
                    currentTurn = data.turn;
                    renderBoard();
                    checkWinner();
                }
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('board').style.display = 'grid';
                document.getElementById('reset-btn').style.display = 'block';
                updateStatus();
            });
        };

        function updateRoom(data) {
            set(ref(db, 'rooms/' + currentRoom), data);
        }

        window.makeMove = (index) => {
            if (gameState[index] !== "" || currentTurn !== myRole) return;
            
            gameState[index] = myRole;
            const nextTurn = myRole === "X" ? "O" : "X";
            updateRoom({ board: gameState, turn: nextTurn });
        };

        function renderBoard() {
            gameState.forEach((val, i) => {
                const cell = document.getElementById(`c${i}`);
                cell.innerText = val;
                cell.className = `cell ${val.toLowerCase()}`;
            });
        }

        function updateStatus() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = `ä½ æ˜¯ ${myRole} | ç¾åœ¨è¼ªåˆ°: ${currentTurn}`;
        }

        function checkWinner() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let combo of wins) {
                const [a, b, c] = combo;
                if (gameState[a] && gameState[a] === gameState[b] && gameState[a] === gameState[c]) {
                    document.getElementById('status').innerText = `ç©å®¶ ${gameState[a]} ç²å‹ï¼ ğŸ‰`;
                    return;
                }
            }
            if (!gameState.includes("")) document.getElementById('status').innerText = "å¹³æ‰‹ï¼ ğŸ¤";
        }

        window.resetGame = () => {
            updateRoom({ board: Array(9).fill(""), turn: "X" });
        };
    </script>
</body>
</html>
