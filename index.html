<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OOXX é›²ç«¯å°æˆ°æœ€çµ‚ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --cell-size: 100px;
            --x-color: #ff4d4d;
            --o-color: #3b82f6;
            --win-bg: #d4edda;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
        }

        .setup-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }

        .status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 50px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, var(--cell-size));
            grid-template-rows: repeat(3, var(--cell-size));
            gap: 12px;
            background-color: #dee2e6;
            padding: 12px;
            border-radius: 12px;
            display: none; /* åˆå§‹éš±è— */
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .cell:hover { background-color: #f1f3f5; }
        .cell.x { color: var(--x-color); }
        .cell.o { color: var(--o-color); }
        .cell.winner-cell { background-color: var(--win-bg); }

        input {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 150px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 25px;
            font-size: 1rem;
            background-color: #212529;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover { opacity: 0.9; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="setup-screen" class="setup-container">
        <h1>OOXX é›²ç«¯å°æˆ°</h1>
        <p>è¼¸å…¥æˆ¿é–“è™Ÿç¢¼é€£ç·šï¼š</p>
        <input type="text" id="room-input" placeholder="ä¾‹å¦‚: 777" maxlength="10">
        <br>
        <button onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
    </div>

    <div id="game-status" class="status hidden">ç­‰å¾…ç©å®¶åŠ å…¥...</div>

    <div id="board" class="board">
        <div class="cell" onclick="makeMove(0)" id="c0"></div>
        <div class="cell" onclick="makeMove(1)" id="c1"></div>
        <div class="cell" onclick="makeMove(2)" id="c2"></div>
        <div class="cell" onclick="makeMove(3)" id="c3"></div>
        <div class="cell" onclick="makeMove(4)" id="c4"></div>
        <div class="cell" onclick="makeMove(5)" id="c5"></div>
        <div class="cell" onclick="makeMove(6)" id="c6"></div>
        <div class="cell" onclick="makeMove(7)" id="c7"></div>
        <div class="cell" onclick="makeMove(8)" id="c8"></div>
    </div>

    <button id="reset-btn" class="hidden" onclick="resetGame()" style="margin-top: 25px; background-color: #6c757d;">é‡æ–°é–‹å§‹</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ä½ çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBiRD8NX4VkzySZACcbccTn0t8KkHLCWKA",
            authDomain: "ooxx-test.firebaseapp.com",
            databaseURL: "https://ooxx-test-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ooxx-test",
            storageBucket: "ooxx-test.firebasestorage.app",
            messagingSenderId: "1044547887449",
            appId: "1:1044547887449:web:1c98e76f50fb36cc952c48"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentRoom = "";
        let myRole = ""; // X æˆ– O
        let gameState = Array(9).fill("");
        let currentTurn = "X";
        let isGameActive = true;

        // åŠ å…¥æˆ¿é–“é‚è¼¯
        window.joinRoom = () => {
            const roomId = document.getElementById('room-input').value.trim();
            if (!roomId) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼ï¼");
            
            currentRoom = roomId;
            const roomRef = ref(db, 'rooms/' + currentRoom);

            // ç›£è½ Firebase æ•¸æ“šè®Šå‹•
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    // æˆ¿é–“æ˜¯ç©ºçš„ï¼Œæˆ‘æ˜¯ X
                    myRole = "X";
                    updateFirebase({
                        board: Array(9).fill(""),
                        turn: "X",
                        winner: ""
                    });
                } else {
                    // å¦‚æœé‚„æ²’è¨­å®šè§’è‰²ï¼Œç¬¬ä¸€å€‹é€²ä¾†æ˜¯ Xï¼Œç¬¬äºŒå€‹æ˜¯ O
                    if (!myRole) myRole = (data.board.filter(x => x!=="").length === 0) ? "X" : "O";
                    
                    gameState = data.board;
                    currentTurn = data.turn;
                    const winner = data.winner;

                    updateUI(winner);
                }
            });

            // åˆ‡æ›é¡¯ç¤ºä»‹é¢
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-status').classList.remove('hidden');
            document.getElementById('board').style.display = 'grid';
            document.getElementById('reset-btn').classList.remove('hidden');
        };

        // é»æ“Šè½å­
        window.makeMove = (index) => {
            if (!isGameActive || gameState[index] !== "" || currentTurn !== myRole) return;

            gameState[index] = myRole;
            const winner = checkWinnerLocal(gameState);
            const nextTurn = myRole === "X" ? "O" : "X";

            updateFirebase({
                board: gameState,
                turn: nextTurn,
                winner: winner || (gameState.includes("") ? "" : "draw")
            });
        };

        // æ›´æ–° UI ç•«é¢
        function updateUI(winner) {
            // æ›´æ–°æ£‹ç›¤æ–‡å­—
            gameState.forEach((val, i) => {
                const cell = document.getElementById(`c${i}`);
                cell.innerText = val;
                cell.className = `cell ${val.toLowerCase()}`;
            });

            const statusEl = document.getElementById('game-status');

            if (winner) {
                isGameActive = false;
                if (winner === "draw") {
                    statusEl.innerText = "é›™æ–¹å¹³æ‰‹ï¼ ğŸ¤";
                } else {
                    statusEl.innerText = `ç©å®¶ ${winner} ç²å‹äº†ï¼ ğŸ‰`;
                }
            } else {
                isGameActive = true;
                statusEl.innerText = `ä½ æ˜¯ ${myRole} | è¼ªåˆ°: ${currentTurn}`;
                if (currentTurn === myRole) {
                    statusEl.style.color = "#28a745";
                } else {
                    statusEl.style.color = "#6c757d";
                }
            }
        }

        // æœ¬åœ°åˆ¤å®šå‹è² 
        function checkWinnerLocal(squares) {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let combo of lines) {
                const [a, b, c] = combo;
                if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
                    return squares[a];
                }
            }
            return null;
        }

        // é‡ç½®éŠæˆ²
        window.resetGame = () => {
            updateFirebase({
                board: Array(9).fill(""),
                turn: "X",
                winner: ""
            });
        };

        // è¼”åŠ©å‡½å¼ï¼šå¯«å…¥è³‡æ–™åº«
        function updateFirebase(data) {
            set(ref(db, 'rooms/' + currentRoom), data);
        }
    </script>
</body>
</html>
